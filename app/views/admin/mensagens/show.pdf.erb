<html>
  <head>
    <meta charset="utf-8" />
  </head>
  <body>

<table style="height: 21px;" width="800">
<tbody>
<tr>
<td style="text-align: center;" rowspan="2"><img style="float: left;" src="http://ceasa.portochibatao.com.br/logo-jf.png" alt="" width="129" height="90" />
<h1><%= resource.navio.name %></h1>
<strong></strong>
</td>
<td style="text-align: right;" colspan="2">&nbsp;&nbsp;<strong>Mensagem</strong></td>
</tr>
<tr>
<td style="text-align: right;" colspan="2"><strong><%= resource.id %></strong></td>
</tr>
</tbody>
</table>
 

<script src='https://api.mapbox.com/mapbox.js/v3.0.1/mapbox.js'></script>
<link href='https://api.mapbox.com/mapbox.js/v3.0.1/mapbox.css' rel='stylesheet' /> 

<link href='/css/leaflet.awesome-markers.css' rel='stylesheet' />
<link href='/css/font-awesome.css' rel='stylesheet' />
 <link rel="stylesheet" href="/css/leaflet.extra-markers.min.css">

<div style='width: 800px;'>
  <div id="map" style='height: 300px;'></div> 
</div>    

<div id="map"></div>

<hr />
<% @viagem = Viagem.where("navio_id = ? and inicio_viagem < ?", resource.navio_id, resource.messagetime).order(:inicio_viagem).last %>
<% if !@viagem.blank? %>
<!--achei viagem -->

<% if @viagem.fim_viagem.blank? %>
<!--tempo viagem -->
<% @tempoviagem = ((resource.messagetime - @viagem.inicio_viagem) / 1.hour).round %>
<% @tempo = (resource.messagetime-@viagem.inicio_viagem)/3600/24 %>
<% @resultado = /(\d+)\.(\d+)/.match(@tempo.to_s)[1] + " dia(s) e " + /(\d+)\.(\d+)/.match((24 * ("0." + (/(\d+)\.(\d+)/.match(@tempo.to_s)[2])).to_d).to_s)[1] + " horas." %>
<!--tempo viagem -->
No momento da mensagem viajando no trecho <%= @viagem.trecho.name %> ha <%= @resultado %>
<% else %> 
No momento da mensagem estava no porto de <%= @viagem.trecho.destino %>
<% end %>


<!--achei viagem -->
<% end %>
<hr />
<%= @mensagem.messagetime.strftime('%d/%m/%y %H:%M') %>
<p><%= simple_format @mensagem.text %></p>


<script type="text/javascript">
L.mapbox.accessToken = 'pk.eyJ1Ijoicm9tdWxvZGFuemVyIiwiYSI6ImNpZzBkZ3BrOTAzNDR0eGt4emVlM2RleWEifQ.6CSLqi0tvqo1yF2zCIt7oA'
var map = L.mapbox.map('map').setView([<%= @mensagem.latitude %>, <%= @mensagem.longitude %>], 7);

  L.tileLayer('https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token=pk.eyJ1Ijoicm9tdWxvZGFuemVyIiwiYSI6ImNpZzBkZ3BrOTAzNDR0eGt4emVlM2RleWEifQ.6CSLqi0tvqo1yF2zCIt7oA', {
    maxZoom: 18,
    attribution: 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors,' +
      'Imagery Â© <a href="http://mapbox.com">Mapbox</a>',
    id: 'mapbox.streets' 
  }).addTo(map);

  L.marker([<%= @mensagem.latitude %>, <%= @mensagem.longitude %>]).addTo(map);


</script>

 </body>
 </html>